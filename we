#!/usr/bin/env bash
set -euo pipefail
# Main 'we' CLI - generates Makefile and README blocks for a module
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$ROOT_DIR/lib/we"
. "$LIB_DIR/common.sh"
. "$LIB_DIR/args.sh"
. "$LIB_DIR/project.sh"
. "$LIB_DIR/fs.sh"
. "$LIB_DIR/watchexec.sh"

main() {
  parse_args "$@"
  resolve_project

  compute_defaults

  if [ "${DRY_RUN:-0}" = "1" ]; then
    echo "DRY RUN: Would generate Makefile and README blocks for service '$SERVICE' in module '$MODULE'"
    exit 0
  fi

  upsert_makefile "$MAKEFILE_OUT"
  upsert_readme "$README_OUT"
  ensure_gitignore

  echo "we: generated Make block and README block for service '$SERVICE'"
  if [ "${YES:-0}" != "1" ]; then
    confirm "Proceed to write files?" || { echo "aborted"; exit 1; }
  fi

  # Write outputs (fs.sh functions already wrote temp files; ensure move)
  finalize_files "$MAKEFILE_OUT" "$README_OUT"

  echo "Done. Run 'make up' to start the service." 
}

main "$@"
